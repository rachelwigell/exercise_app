<script type="text/javascript" src="http://code.jquery.com/jquery-1.7.1.min.js"></script>

<div id="workout_configuration">
	<b><label for="workout_type">Workout type</label></b>
	<div>
	  <input type="radio" id="upper" name="workout_type" value="upper" checked>
	  <label for="upper">Upper</label>
	</div>
	<div>
	  <input type="radio" id="lower" name="workout_type" value="lower">
	  <label for="lower">Lower</label>
	</div>
	<div>
	  <input type="radio" id="core" name="workout_type" value="core">
	  <label for="core">Core</label>
	</div>
	<div>
	  <input type="radio" id="upper_core" name="workout_type" value="upper_core">
	  <label for="core">Upper + Core</label>
	</div>
	<div>
	  <input type="radio" id="lower_core" name="workout_type" value="lower_core">
	  <label for="core">Lower + Core</label>
	</div>

	<br>

	<label for="exercises_csv">Exercises spreadsheet URL:</label><br>
  	<input type="text" id="exercises_csv" name="exercises_csv" value="https://raw.githubusercontent.com/rachelwigell/exercise_app/master/exercises.csv">

	<br>
	<br>

	<label for="num_exercises">Number of exercises:</label>
	<input type="number" id="num_exercises" name="num_exercises" value="10" onChange="show_working_and_total_time()">

	<br>

	<label for="num_sets">Sets for each exercise:</label>
	<input type="number" id="num_sets" name="num_sets" value="2" onChange="show_working_and_total_time()">

	<br>

	<label for="set_time">Working time per set (seconds):</label>
	<input type="number" id="set_time" name="set_time" value="45" onChange="show_working_and_total_time()">

	<br>

	<label for="rest_time">Rest time between sets (seconds):</label>
	<input type="number" id="rest_time" name="rest_time" value="30" onChange="show_working_and_total_time()">

	<br>
	<br>

	<div id=total_working_time><b>Total working time: </b><div id="total_working_time_value"></div></div>
	<div id="total_workout_length"><b>Total workout length: </b><div id="total_workout_length_value"></div></div>

	<br>

	<button type="button" id="start_workout" onClick="start_workout()">Start</button>
</div>

<div id="exercise_screen">
	<b><div id="message"></div></b>
	<b><div id="exercise_name"></div></b>
	<div id="exercise_image"></div>
	<div id="countdown"></div>
	<div id="pause_button"></div>
</div>

<script>

	// global variables
	var workout = [];
	var current_exercise_data = {};
	var workout_options = {};
	var interval = null;

	// function calls
	show_working_and_total_time();

	// control flow

	function exercise_loop() {
		interval = setInterval(update_exercise, 1000);
	}

	function rest_loop() {
		interval = setInterval(update_rest, 1000);
	}

	function pause_workout() {
		clearInterval(interval);
		switch_button("resume_workout");
	}

	function resume_workout() {
		interval = setInterval(update_exercise, 1000);
		switch_button("pause_workout");
	}

	function pause_rest() {
		clearInterval(interval);
		switch_button("resume_rest");
	}

	function resume_rest() {
		interval = setInterval(update_rest, 1000);
		switch_button("pause_rest");
	}

	// update HTML

	function show_working_and_total_time() {
		var num_exercises = document.getElementById("num_exercises").value;
		var sets_per_exercise = document.getElementById("num_sets").value;
		var working_time_per_set = document.getElementById("set_time").value;
		var rest_time_between = document.getElementById("rest_time").value;

		var total_working_time = num_exercises*sets_per_exercise*working_time_per_set;
		var total_rest_time = rest_time_between * (num_exercises*sets_per_exercise-1);
		var total_time = total_working_time + total_rest_time;
		total_working_time = seconds_to_readable_string(total_working_time);
		total_time = seconds_to_readable_string(total_time);

		document.getElementById("total_working_time_value").innerHTML=total_working_time; 
		document.getElementById("total_workout_length_value").innerHTML=total_time; 
	}

	function populate_exercise_screen(exercise_data) {
		var exercise_name = exercise_data['exercise']
		var set_num = exercise_data['set_num']
		var time_remaining = exercise_data['time_remaining']
		var workout_header = `${exercise_name} (set ${set_num})`

		document.getElementById("exercise_name").innerHTML=workout_header;
		document.getElementById("countdown").innerHTML=time_remaining;
		switch_button("pause_workout");
	}

	function clear_exercise_screen() {
		document.getElementById("exercise_name").innerHTML="";
		document.getElementById("countdown").innerHTML="";
	}

	function populate_rest_screen(exercise_data) {
		var next_exercise_name = exercise_data['exercise']
		var set_num = exercise_data['set_num']
		var rest_time_remaining = exercise_data['rest_time_remaining']
		var workout_header = `Next exercise: ${next_exercise_name} (set ${set_num})`

		document.getElementById("message").innerHTML="Rest time! Grab some water.";
		document.getElementById("exercise_name").innerHTML=workout_header;
		document.getElementById("countdown").innerHTML=rest_time_remaining;
		switch_button("pause_rest");
	}

	function switch_button(button_choice) {
		if(button_choice == "pause_workout") {
			var button_html = '<button type="button" id="pause_button" onClick="pause_workout()">Pause</button>';
		}
		else if(button_choice == "resume_workout") {
			var button_html = '<button type="button" id="pause_button" onClick="resume_workout()">Resume</button>';
		}
		else if(button_choice == "pause_rest") {
			var button_html = '<button type="button" id="pause_button" onClick="pause_rest()">Pause</button>';
		}
		else if(button_choice == "resume_rest") {
			var button_html = '<button type="button" id="pause_button" onClick="resume_rest()">Resume</button>';
		}
		document.getElementById("pause_button").innerHTML=button_html;
	}

	function clear_rest_screen(){
		document.getElementById("message").innerHTML="";
		document.getElementById("exercise_name").innerHTML="";
		document.getElementById("countdown").innerHTML="";
	}

	// data processing

	function capture_workout_choices() {
		var num_exercises = document.getElementById("num_exercises").value;
		var sets_per_exercise = document.getElementById("num_sets").value;
		var working_time_per_set = document.getElementById("set_time").value;
		var rest_time_between = document.getElementById("rest_time").value;
		var workout_type = get_selected_radio_button("workout_type");
		var spreadsheet_url = document.getElementById("exercises_csv").value;

		var workout_options = {};
		workout_options['num_exercises'] = num_exercises;
		workout_options['sets_per_exercise'] = sets_per_exercise;
		workout_options['working_time_per_set'] = working_time_per_set;
		workout_options['rest_time_between'] = rest_time_between;
		workout_options['spreadsheet_url'] = spreadsheet_url;

		var valid_workout_types = {
			'upper': ['upper'],
			'lower': ['lower'],
			'core': ['core'],
			'upper_core': ['upper', 'core'],
			'lower_core': ['lower', 'core']
		}[workout_type];

		workout_options['valid_workout_types'] = valid_workout_types;
		return workout_options
	}

	function read_exercise_csv(csv_url) {
		var data = $.ajax({
	        type: "GET",
	        url: csv_url,
	        dataType: "text",
	        async: false
	     }).responseText;
		
		var parsed_data = data.split('\n');
		for(var i=0; i<parsed_data.length; i++) {
			parsed_data[i] = parsed_data[i].split(',');
		}
		
		return parsed_data;
	}

	function design_workout(parsed_data, workout_options) {
		var valid_workout_types = workout_options['valid_workout_types'];
		var num_exercises = workout_options['num_exercises'];

		var valid_workouts = [];
		var valid_workouts_consumable = [];
		for(var row_index=0; row_index<parsed_data.length; row_index++){
			if(valid_workout_types.includes(parsed_data[row_index][1])) {
				valid_workouts.push(parsed_data[row_index]);
				valid_workouts_consumable.push(parsed_data[row_index]);
			}
		}
		
		var workout_plan = []
		for(var execise_num=0; execise_num<num_exercises; execise_num++) {
			var chosen_index = random_range(0, valid_workouts_consumable.length);
			workout_plan.push(valid_workouts_consumable[chosen_index]);
			valid_workouts_consumable.splice(chosen_index, 1);
			if(valid_workouts_consumable.length == 0) {
				valid_workouts_consumable = deep_copy(valid_workouts);
			}
		}

		return workout_plan;
	}

	function start_workout() {
		workout_options = capture_workout_choices();
		document.getElementById("workout_configuration").innerHTML=""; 
		var parsed_data = read_exercise_csv(workout_options['spreadsheet_url']);
		workout = design_workout(parsed_data, workout_options);
		current_exercise_data = {
			'current_exercise_index': 0,
			'exercise': workout[0][0],
			'set_num': 1,
			'time_remaining': workout_options['working_time_per_set'],
			'rest_time_remaining': null
		}
		populate_exercise_screen(current_exercise_data);
		exercise_loop();
	}

	function update_exercise(){
		var time_remaining = current_exercise_data['time_remaining'];
		if(time_remaining > 0){
			current_exercise_data['time_remaining'] -= 1;
			populate_exercise_screen(current_exercise_data);
		}
		else {
			clearInterval(interval);
			clear_exercise_screen();
			increment_exercise_or_set();
			populate_rest_screen(current_exercise_data);
			rest_loop();
		}
	}

	function update_rest() {
		var time_remaining = current_exercise_data['rest_time_remaining'];
		if(time_remaining > 0){
			current_exercise_data['rest_time_remaining'] -= 1;
			populate_rest_screen(current_exercise_data);
		}
		else {
			clearInterval(interval);
			clear_rest_screen();
			populate_exercise_screen(current_exercise_data);
			exercise_loop();
		}
	}

	function increment_exercise_or_set(){
		if(current_exercise_data['set_num'] < workout_options['sets_per_exercise']) {
			current_exercise_data['set_num'] += 1;
			current_exercise_data['time_remaining'] = workout_options['working_time_per_set'];
			current_exercise_data['rest_time_remaining'] = workout_options['rest_time_between'];
		}
		else {
			current_exercise_data['set_num'] = 1;
			current_exercise_data['current_exercise_index'] += 1;
			current_exercise_data['exercise'] = workout[current_exercise_data['current_exercise_index']][0];
			current_exercise_data['time_remaining'] = workout_options['working_time_per_set'];
			current_exercise_data['rest_time_remaining'] = workout_options['rest_time_between'];
		}
	}

	// helpers

	function seconds_to_readable_string(seconds) {
		var readable = new Date(seconds * 1000).toISOString().substr(11, 8);
		var readable = readable.replace(":", " hours ");
		var readable = readable.replace(":", " minutes ");
		var readable = readable + " seconds";
		return readable;
	}

	function get_selected_radio_button(button_group_name) {
		var buttons = document.getElementsByName(button_group_name);
		var selected_button;

		for(var i = 0; i < buttons.length; i++) {
		   if(buttons[i].checked)
		       selected_button = buttons[i].value;
		 }

		 return selected_button;
	}

	function deep_copy(array_of_arrays) {
		var new_array = [];
		for(var i=0; i<array_of_arrays.length; i++){
			new_array[i] = []
			for(var j=0; j<array_of_arrays[i].length; j++){
				new_array[i][j] = array_of_arrays[i][j];
			}
		}
		return new_array;
	}

	function random_range(min, max) {
	  min = Math.ceil(min);
	  max = Math.floor(max);
	  return Math.floor(Math.random() * (max - min) + min);
	}

</script>